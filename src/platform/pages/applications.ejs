<!-- Applications Page - API Keys Management -->
<div class="space-y-6 animate-fade-in">

    <!-- Page Header -->
    <div class="dark-glass rounded-xl border border-gray-700/50 p-4 sm:p-6 md:p-8">
        <div class="flex items-center gap-3 sm:gap-4">
            <div class="w-12 h-12 sm:w-14 sm:h-14 md:w-16 md:h-16 rounded-full bg-gradient-to-br from-orange-600 to-amber-600 flex items-center justify-center flex-shrink-0 animate-float">
                <i data-lucide="plug" class="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8 text-white"></i>
            </div>
            <div class="flex-1 min-w-0">
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-white">Aplicações</h1>
                <p class="text-sm sm:text-base text-gray-400">Gerencie suas API Keys para integração</p>
            </div>
        </div>
        
        <!-- Stats + Actions (Desktop) -->
        <div class="hidden sm:flex items-center justify-between mt-4 pt-4 border-t border-gray-700/50">
            <div class="flex items-center gap-2 text-sm text-gray-500">
                <i data-lucide="plug" class="w-4 h-4"></i>
                <span>Total de aplicações:</span>
                <span class="font-medium text-orange-400" x-text="applications.length"></span>
            </div>
            <div class="flex items-center gap-2">
                <button
                    @click="loadApplications()"
                    :disabled="isLoadingApplications"
                    class="w-9 h-9 flex items-center justify-center hover:bg-gray-700/50 rounded-lg transition-colors border border-gray-700/50"
                    title="Atualizar lista"
                >
                    <span class="flex items-center justify-center" :class="isLoadingApplications ? 'animate-spin' : ''"><i data-lucide="refresh-cw" class="w-5 h-5 text-gray-400"></i></span>
                </button>
                <button
                    @click="showCreateApplicationModal = true"
                    class="px-4 py-2 bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-700 hover:to-amber-700 rounded-lg font-medium text-sm text-white transition-all duration-200 flex items-center gap-2"
                    title="Criar nova aplicação"
                >
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>Nova Aplicação</span>
                </button>
            </div>
        </div>
        
        <!-- Stats Only (Mobile) -->
        <div class="flex sm:hidden items-center gap-2 text-xs text-gray-500 mt-4">
            <i data-lucide="plug" class="w-4 h-4"></i>
            <span>Total de aplicações:</span>
            <span class="font-medium text-orange-400" x-text="applications.length"></span>
        </div>
    </div>


    <!-- Loading State -->
    <template x-if="isLoadingApplications">
        <div class="dark-glass rounded-xl border border-gray-700/50 p-12 text-center">
            <i data-lucide="loader-2" class="w-12 h-12 text-orange-500 mx-auto mb-4 animate-spin"></i>
            <p class="text-gray-400">Carregando aplicações...</p>
        </div>
    </template>

    <!-- Empty State -->
    <template x-if="!isLoadingApplications && applications.length === 0">
        <div class="dark-glass rounded-xl border border-gray-700/50 p-12 text-center">
            <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gray-800 flex items-center justify-center">
                <i data-lucide="plug" class="w-10 h-10 text-gray-600"></i>
            </div>
            <h3 class="text-lg font-semibold text-white mb-2">Nenhuma aplicação cadastrada</h3>
            <p class="text-gray-400 mb-6">Crie sua primeira aplicação para obter uma API Key</p>
            <button
                @click="showCreateApplicationModal = true"
                class="px-6 py-3 bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-700 hover:to-amber-700 rounded-xl font-medium transition-all duration-200 inline-flex items-center gap-2"
            >
                <i data-lucide="plus" class="w-5 h-5"></i>
                <span>Criar Aplicação</span>
            </button>
        </div>
    </template>

    <!-- Applications Grid -->
    <template x-if="!isLoadingApplications && applications.length > 0">
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            <template x-for="app in applications" :key="app.id">
                <div class="dark-glass rounded-xl border border-gray-700/50 p-5 hover:border-orange-500/50 transition-all duration-200 hover:scale-[1.02] active:scale-[0.98]">
                    <!-- Header -->
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div 
                                class="w-10 h-10 rounded-lg flex items-center justify-center"
                                :class="app.isActive 
                                    ? 'bg-gradient-to-br from-orange-500 to-amber-500' 
                                    : 'bg-gray-700'"
                            >
                                <i data-lucide="key" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-white" x-text="app.name"></h3>
                                <span 
                                    class="text-xs px-2 py-0.5 rounded-full"
                                    :class="app.isActive 
                                        ? 'bg-green-500/20 text-green-400' 
                                        : 'bg-red-500/20 text-red-400'"
                                    x-text="app.isActive ? 'Ativo' : 'Inativo'"
                                ></span>
                            </div>
                        </div>
                        
                        <!-- Actions Menu -->
                        <div class="relative" x-data="{ open: false }">
                            <button 
                                @click="open = !open"
                                class="p-2 hover:bg-gray-700/50 rounded-lg transition-colors"
                            >
                                <i data-lucide="more-vertical" class="w-4 h-4 text-gray-400"></i>
                            </button>
                            
                            <div 
                                x-show="open" 
                                @click.outside="open = false"
                                x-transition
                                class="absolute right-0 top-full mt-1 w-48 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-10 overflow-hidden"
                            >
                                <button 
                                    @click="editApplication(app); open = false"
                                    class="w-full px-4 py-2.5 text-left text-sm text-gray-300 hover:bg-gray-700 flex items-center gap-2"
                                >
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                    Editar
                                </button>
                                <button 
                                    @click="viewApplicationKey(app); open = false"
                                    class="w-full px-4 py-2.5 text-left text-sm text-gray-300 hover:bg-gray-700 flex items-center gap-2"
                                >
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                    Ver API Key
                                </button>
                                <button 
                                    @click="confirmRegenerateKey(app); open = false"
                                    class="w-full px-4 py-2.5 text-left text-sm text-yellow-400 hover:bg-gray-700 flex items-center gap-2"
                                >
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    Regenerar Key
                                </button>
                                <button 
                                    @click="toggleApplicationStatus(app); open = false"
                                    class="w-full px-4 py-2.5 text-left text-sm hover:bg-gray-700 flex items-center gap-2"
                                    :class="app.isActive ? 'text-orange-400' : 'text-green-400'"
                                >
                                    <i :data-lucide="app.isActive ? 'pause' : 'play'" class="w-4 h-4"></i>
                                    <span x-text="app.isActive ? 'Desativar' : 'Ativar'"></span>
                                </button>
                                <div class="border-t border-gray-700"></div>
                                <button 
                                    @click="confirmDeleteApplication(app); open = false"
                                    class="w-full px-4 py-2.5 text-left text-sm text-red-400 hover:bg-gray-700 flex items-center gap-2"
                                >
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    Excluir
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <p 
                        x-show="app.description" 
                        class="text-sm text-gray-400 mb-4 line-clamp-2"
                        x-text="app.description"
                    ></p>
                    
                    <!-- API Key Preview -->
                    <div class="bg-gray-900/50 rounded-lg p-3 mb-4">
                        <div class="flex items-center justify-between">
                            <code class="text-xs text-gray-400 font-mono" x-text="app.keyPreview"></code>
                            <button 
                                @click="copyApiKey(app)"
                                class="p-1.5 hover:bg-gray-700 rounded transition-colors"
                                title="Copiar API Key completa"
                            >
                                <i data-lucide="copy" class="w-4 h-4 text-gray-400"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="text-xs text-gray-500">
                        Criado em <span x-text="new Date(app.createdAt).toLocaleDateString('pt-BR')"></span>
                    </div>
                </div>
            </template>
        </div>
    </template>
</div>

<!-- Create/Edit Application Modal -->
<div
    x-show="showCreateApplicationModal || showEditApplicationModal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
>
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" @click="closeApplicationModal()"></div>
    
    <!-- Modal -->
    <div
        class="relative dark-glass rounded-xl border border-gray-700/50 w-full max-w-md"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        @click.stop
    >
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-700/50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-600 to-amber-600 flex items-center justify-center">
                    <i :data-lucide="showEditApplicationModal ? 'pencil' : 'plus'" class="w-5 h-5 text-white"></i>
                </div>
                <h2 class="text-xl font-bold text-white" x-text="showEditApplicationModal ? 'Editar Aplicação' : 'Nova Aplicação'"></h2>
            </div>
            <button @click="closeApplicationModal()" class="p-2 hover:bg-gray-700/50 rounded-lg transition-colors">
                <i data-lucide="x" class="w-5 h-5 text-gray-400"></i>
            </button>
        </div>
        
        <!-- Form -->
        <form @submit.prevent="showEditApplicationModal ? updateApplication() : createApplication()" class="p-6 space-y-4">
            <!-- Name -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">
                    Nome da Aplicação *
                </label>
                <input
                    type="text"
                    x-model="applicationForm.name"
                    placeholder="Ex: Meu App Mobile"
                    class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/50"
                    required
                />
            </div>
            
            <!-- Description -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">
                    Descrição (opcional)
                </label>
                <textarea
                    x-model="applicationForm.description"
                    placeholder="Descreva para que serve esta aplicação..."
                    rows="3"
                    class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/50 resize-none"
                ></textarea>
            </div>
            
            <!-- Active Toggle (only on edit) -->
            <div x-show="showEditApplicationModal" class="flex items-center justify-between">
                <span class="text-sm text-gray-300">Aplicação ativa</span>
                <button
                    type="button"
                    @click="applicationForm.isActive = !applicationForm.isActive"
                    class="relative w-12 h-6 rounded-full transition-colors duration-200"
                    :class="applicationForm.isActive ? 'bg-orange-600' : 'bg-gray-700'"
                >
                    <div
                        class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform duration-200"
                        :class="applicationForm.isActive && 'translate-x-6'"
                    ></div>
                </button>
            </div>
            
            <!-- Submit Button -->
            <button
                type="submit"
                :disabled="isSavingApplication"
                class="w-full px-6 py-3 bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-700 hover:to-amber-700 rounded-lg font-medium text-white transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
                <span x-show="!isSavingApplication" class="flex items-center gap-2">
                    <i :data-lucide="showEditApplicationModal ? 'check' : 'plus'" class="w-5 h-5"></i>
                    <span x-text="showEditApplicationModal ? 'Salvar Alterações' : 'Criar Aplicação'"></span>
                </span>
                <span x-show="isSavingApplication" class="flex items-center gap-2">
                    <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    Salvando...
                </span>
            </button>
        </form>
    </div>
</div>

<!-- View API Key Modal -->
<div
    x-show="showApiKeyModal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
>
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" @click="showApiKeyModal = false"></div>
    
    <!-- Modal -->
    <div
        class="relative dark-glass rounded-xl border border-gray-700/50 w-full max-w-lg"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        @click.stop
    >
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-700/50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-600 to-emerald-600 flex items-center justify-center">
                    <i data-lucide="key" class="w-5 h-5 text-white"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-white">API Key</h2>
                    <p class="text-sm text-gray-400" x-text="selectedApplication?.name"></p>
                </div>
            </div>
            <button @click="showApiKeyModal = false" class="p-2 hover:bg-gray-700/50 rounded-lg transition-colors">
                <i data-lucide="x" class="w-5 h-5 text-gray-400"></i>
            </button>
        </div>
        
        <!-- Content -->
        <div class="p-6 space-y-4">
            <div class="bg-gray-900/50 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="alert-triangle" class="w-4 h-4 text-yellow-500"></i>
                    <span class="text-sm text-yellow-500">Mantenha esta chave em segredo!</span>
                </div>
                <div class="relative">
                    <code 
                        class="block w-full bg-gray-800 rounded-lg p-3 text-sm text-green-400 font-mono break-all"
                        x-text="selectedApplication?.key"
                    ></code>
                </div>
            </div>
            
            <button
                @click="copyFullApiKey()"
                class="w-full px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
            >
                <i data-lucide="copy" class="w-5 h-5"></i>
                Copiar API Key
            </button>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div
    x-show="showDeleteApplicationModal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
>
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" @click="showDeleteApplicationModal = false"></div>
    
    <!-- Modal -->
    <div
        class="relative dark-glass rounded-xl border border-gray-700/50 w-full max-w-md"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        @click.stop
    >
        <div class="p-6 text-center">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center">
                <i data-lucide="trash-2" class="w-8 h-8 text-red-500"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Excluir Aplicação?</h3>
            <p class="text-gray-400 mb-6">
                Tem certeza que deseja excluir <strong class="text-white" x-text="selectedApplication?.name"></strong>? 
                Esta ação não pode ser desfeita.
            </p>
            <div class="flex gap-3">
                <button
                    @click="showDeleteApplicationModal = false"
                    class="flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium transition-colors"
                >
                    Cancelar
                </button>
                <button
                    @click="deleteApplication()"
                    :disabled="isDeletingApplication"
                    class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-medium transition-colors disabled:opacity-50 flex items-center justify-center gap-2"
                >
                    <span x-show="!isDeletingApplication">Excluir</span>
                    <span x-show="isDeletingApplication" class="flex items-center gap-2">
                        <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Regenerate Key Modal -->
<div
    x-show="showRegenerateKeyModal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
>
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" @click="showRegenerateKeyModal = false"></div>
    
    <!-- Modal -->
    <div
        class="relative dark-glass rounded-xl border border-gray-700/50 w-full max-w-md"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        @click.stop
    >
        <div class="p-6 text-center">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-yellow-500/20 flex items-center justify-center">
                <i data-lucide="refresh-cw" class="w-8 h-8 text-yellow-500"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Regenerar API Key?</h3>
            <p class="text-gray-400 mb-6">
                A API Key atual de <strong class="text-white" x-text="selectedApplication?.name"></strong> será invalidada. 
                Todas as integrações usando a chave antiga deixarão de funcionar.
            </p>
            <div class="flex gap-3">
                <button
                    @click="showRegenerateKeyModal = false"
                    class="flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium transition-colors"
                >
                    Cancelar
                </button>
                <button
                    @click="regenerateKey()"
                    :disabled="isRegeneratingKey"
                    class="flex-1 px-4 py-3 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-medium transition-colors disabled:opacity-50 flex items-center justify-center gap-2"
                >
                    <span x-show="!isRegeneratingKey">Regenerar</span>
                    <span x-show="isRegeneratingKey" class="flex items-center gap-2">
                        <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>
