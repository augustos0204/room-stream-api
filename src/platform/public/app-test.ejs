<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Test - RoomStream</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        .dark-glass {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(12px);
        }
        .log-entry {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.75rem;
        }
    </style>
</head>
<body class="bg-slate-950 bg-gradient-to-br from-slate-950 via-purple-950 to-indigo-950 text-white min-h-screen p-4 sm:p-8">
    <div class="max-w-4xl mx-auto space-y-6">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold bg-gradient-to-r from-orange-400 to-amber-400 bg-clip-text text-transparent">
                ðŸ”‘ Application Test
            </h1>
            <p class="text-gray-400 mt-2">Teste conexÃµes WebSocket usando API Keys de aplicaÃ§Ãµes</p>
        </div>

        <!-- Connection Card -->
        <div class="dark-glass rounded-xl border border-gray-700/50 p-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <span class="w-8 h-8 rounded-lg bg-gradient-to-br from-orange-500 to-amber-500 flex items-center justify-center text-sm">1</span>
                ConexÃ£o
            </h2>
            
            <div class="space-y-4">
                <!-- App Key Input -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Application API Key</label>
                    <input 
                        type="text" 
                        id="appKey" 
                        placeholder="app_abc123..."
                        class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/50 font-mono text-sm"
                    />
                </div>

                <!-- WebSocket URL -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">WebSocket Namespace</label>
                    <input 
                        type="text" 
                        id="wsNamespace" 
                        value="/ws/rooms"
                        class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-orange-500 font-mono text-sm"
                    />
                </div>

                <!-- Connect Button -->
                <div class="flex gap-3">
                    <button 
                        id="btnConnect"
                        onclick="connect()"
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 rounded-lg font-medium transition-all"
                    >
                        Conectar
                    </button>
                    <button 
                        id="btnDisconnect"
                        onclick="disconnect()"
                        disabled
                        class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Desconectar
                    </button>
                </div>

                <!-- Connection Status -->
                <div id="connectionStatus" class="flex items-center gap-2 text-sm">
                    <div class="w-3 h-3 rounded-full bg-gray-500"></div>
                    <span class="text-gray-400">Desconectado</span>
                </div>
            </div>
        </div>

        <!-- Room Card -->
        <div class="dark-glass rounded-xl border border-gray-700/50 p-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <span class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-sm">2</span>
                Sala
            </h2>
            
            <div class="space-y-4">
                <!-- Room ID Input -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Room ID</label>
                    <input 
                        type="text" 
                        id="roomId" 
                        placeholder="room_123..."
                        class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/50 font-mono text-sm"
                    />
                </div>

                <!-- Join/Leave Buttons -->
                <div class="flex gap-3">
                    <button 
                        id="btnJoin"
                        onclick="joinRoom()"
                        disabled
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Entrar na Sala
                    </button>
                    <button 
                        id="btnLeave"
                        onclick="leaveRoom()"
                        disabled
                        class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Sair da Sala
                    </button>
                </div>

                <!-- Room Status -->
                <div id="roomStatus" class="text-sm text-gray-400">
                    NÃ£o estÃ¡ em nenhuma sala
                </div>
            </div>
        </div>

        <!-- Message Card -->
        <div class="dark-glass rounded-xl border border-gray-700/50 p-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <span class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-sm">3</span>
                Mensagem
            </h2>
            
            <div class="space-y-4">
                <!-- Event Name -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Evento</label>
                    <input 
                        type="text" 
                        id="eventName" 
                        value="message"
                        placeholder="message"
                        class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 font-mono text-sm"
                    />
                </div>

                <!-- Message Input -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Mensagem</label>
                    <div class="flex gap-3">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Digite sua mensagem..."
                            class="flex-1 bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50"
                            onkeypress="if(event.key === 'Enter') sendMessage()"
                        />
                        <button 
                            id="btnSend"
                            onclick="sendMessage()"
                            disabled
                            class="px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Enviar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Card -->
        <div class="dark-glass rounded-xl border border-gray-700/50 p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <span class="w-8 h-8 rounded-lg bg-gradient-to-br from-gray-600 to-gray-700 flex items-center justify-center text-sm">ðŸ“‹</span>
                    Logs
                </h2>
                <button 
                    onclick="clearLogs()"
                    class="text-sm text-gray-400 hover:text-white transition-colors"
                >
                    Limpar
                </button>
            </div>
            
            <div 
                id="logsContainer" 
                class="bg-gray-900/50 rounded-lg p-4 h-64 overflow-y-auto space-y-1"
            >
                <div class="log-entry text-gray-500">Aguardando conexÃ£o...</div>
            </div>
        </div>

        <!-- Help -->
        <div class="text-center text-sm text-gray-500">
            <p>Copie a API Key de uma aplicaÃ§Ã£o criada em <a href="/platform" class="text-orange-400 hover:underline">/platform</a> â†’ AplicaÃ§Ãµes</p>
        </div>
    </div>

    <script>
        let socket = null;
        let currentRoom = null;

        function log(message, type = 'info') {
            const container = document.getElementById('logsContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-gray-400',
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400',
                received: 'text-cyan-400',
                sent: 'text-purple-400'
            };
            
            entry.innerHTML = `<span class="text-gray-600">[${timestamp}]</span> <span class="${colors[type] || colors.info}">${message}</span>`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logsContainer').innerHTML = '';
            log('Logs limpos', 'info');
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            const btnConnect = document.getElementById('btnConnect');
            const btnDisconnect = document.getElementById('btnDisconnect');
            const btnJoin = document.getElementById('btnJoin');

            if (connected) {
                status.innerHTML = '<div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div><span class="text-green-400">Conectado</span>';
                btnConnect.disabled = true;
                btnDisconnect.disabled = false;
                btnJoin.disabled = false;
            } else {
                status.innerHTML = '<div class="w-3 h-3 rounded-full bg-gray-500"></div><span class="text-gray-400">Desconectado</span>';
                btnConnect.disabled = false;
                btnDisconnect.disabled = true;
                btnJoin.disabled = true;
                updateRoomStatus(false);
            }
        }

        function updateRoomStatus(inRoom, roomId = null) {
            const status = document.getElementById('roomStatus');
            const btnLeave = document.getElementById('btnLeave');
            const btnSend = document.getElementById('btnSend');

            if (inRoom && roomId) {
                status.innerHTML = `<span class="text-green-400">âœ“ Na sala:</span> <code class="bg-gray-800 px-2 py-1 rounded">${roomId}</code>`;
                btnLeave.disabled = false;
                btnSend.disabled = false;
                currentRoom = roomId;
            } else {
                status.innerHTML = '<span class="text-gray-400">NÃ£o estÃ¡ em nenhuma sala</span>';
                btnLeave.disabled = true;
                btnSend.disabled = true;
                currentRoom = null;
            }
        }

        function connect() {
            const appKey = document.getElementById('appKey').value.trim();
            const namespace = document.getElementById('wsNamespace').value.trim();

            if (!appKey) {
                log('âŒ Insira a API Key da aplicaÃ§Ã£o', 'error');
                return;
            }

            log(`Conectando com x-app-key...`, 'info');

            socket = io(namespace, {
                auth: { appKey: appKey },
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                log(`âœ… Conectado! Socket ID: ${socket.id}`, 'success');
                updateConnectionStatus(true);
            });

            socket.on('disconnect', (reason) => {
                log(`âŒ Desconectado: ${reason}`, 'error');
                updateConnectionStatus(false);
            });

            socket.on('connect_error', (error) => {
                log(`âŒ Erro de conexÃ£o: ${error.message}`, 'error');
                updateConnectionStatus(false);
            });

            socket.on('error', (data) => {
                log(`âš ï¸ Erro: ${data.message}`, 'error');
            });

            // Room events
            socket.on('joinedRoom', (data) => {
                log(`âœ… Entrou na sala: ${data.roomName} (${data.roomId})`, 'success');
                log(`   Participantes: ${data.participants.length}`, 'info');
                updateRoomStatus(true, data.roomId);
            });

            socket.on('leftRoom', (data) => {
                log(`ðŸ‘‹ Saiu da sala: ${data.roomId}`, 'warning');
                updateRoomStatus(false);
            });

            socket.on('userJoined', (data) => {
                log(`ðŸ‘¤ ${data.participantName || 'AlguÃ©m'} entrou na sala`, 'received');
            });

            socket.on('userLeft', (data) => {
                log(`ðŸ‘¤ ${data.participantName || 'AlguÃ©m'} saiu da sala`, 'received');
            });

            // Listen to all events for messages
            socket.onAny((eventName, data) => {
                // Skip internal events
                const skipEvents = ['connect', 'disconnect', 'error', 'joinedRoom', 'leftRoom', 'userJoined', 'userLeft', 'roomInfo', 'participantNameUpdated', 'roomDeleted', 'tokenExpired'];
                if (skipEvents.includes(eventName)) return;

                const sender = data.application?.name || data.supabaseUser?.email || data.clientId || 'Unknown';
                const isApp = data.isApplication ? '[APP] ' : '';
                log(`ðŸ“¨ [${eventName}] ${isApp}${sender}: ${data.message}`, 'received');
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                log('Desconectado manualmente', 'warning');
                updateConnectionStatus(false);
            }
        }

        function joinRoom() {
            const roomId = document.getElementById('roomId').value.trim();
            
            if (!roomId) {
                log('âŒ Insira o Room ID', 'error');
                return;
            }

            if (!socket || !socket.connected) {
                log('âŒ NÃ£o estÃ¡ conectado', 'error');
                return;
            }

            log(`Entrando na sala: ${roomId}...`, 'info');
            socket.emit('joinRoom', { roomId });
        }

        function leaveRoom() {
            if (!currentRoom) {
                log('âŒ NÃ£o estÃ¡ em nenhuma sala', 'error');
                return;
            }

            log(`Saindo da sala: ${currentRoom}...`, 'info');
            socket.emit('leaveRoom', { roomId: currentRoom });
        }

        function sendMessage() {
            const message = document.getElementById('messageInput').value.trim();
            const eventName = document.getElementById('eventName').value.trim() || 'message';

            if (!message) {
                log('âŒ Digite uma mensagem', 'error');
                return;
            }

            if (!currentRoom) {
                log('âŒ Entre em uma sala primeiro', 'error');
                return;
            }

            socket.emit('emit', {
                roomId: currentRoom,
                message: message,
                event: eventName
            });

            log(`ðŸ“¤ [${eventName}] Enviado: ${message}`, 'sent');
            document.getElementById('messageInput').value = '';
        }

        // Load saved values from localStorage
        document.addEventListener('DOMContentLoaded', () => {
            const savedAppKey = localStorage.getItem('appTestKey');
            const savedRoomId = localStorage.getItem('appTestRoomId');
            
            if (savedAppKey) document.getElementById('appKey').value = savedAppKey;
            if (savedRoomId) document.getElementById('roomId').value = savedRoomId;

            // Save on change
            document.getElementById('appKey').addEventListener('change', (e) => {
                localStorage.setItem('appTestKey', e.target.value);
            });
            document.getElementById('roomId').addEventListener('change', (e) => {
                localStorage.setItem('appTestRoomId', e.target.value);
            });
        });
    </script>
</body>
</html>
