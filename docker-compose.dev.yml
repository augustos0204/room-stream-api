version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: room-stream-api-dev
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
      - "9229:9229"  # Debug port
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3000
      CORS_ORIGIN: ${CORS_ORIGIN:-*}
      WEBSOCKET_NAMESPACE: ${WEBSOCKET_NAMESPACE:-/ws/rooms}
      
      # Autenticação - API Key
      API_KEY: ${API_KEY:-}
      
      # Autenticação - Supabase
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-}
      TOKEN_VALIDATION_INTERVAL: ${TOKEN_VALIDATION_INTERVAL:-300000}
      
      # Informações da aplicação
      APP_NAME: ${APP_NAME:-NestJS WebSocket Room API}
      APP_VERSION: ${APP_VERSION:-1.0.0}
    volumes:
      # Mount source code for hot reload
      - ./src:/app/src:ro
      - ./package.json:/app/package.json:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      - ./tsconfig.build.json:/app/tsconfig.build.json:ro
      # Node modules como volume nomeado para performance
      - node_modules:/app/node_modules
    networks:
      - app-network
    command: pnpm run start:debug

volumes:
  node_modules:

networks:
  app-network:
    driver: bridge
